{% extends "base.html" %}

{% block title %}Admin Settings - GameStore{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        <!-- Sidebar -->
        <div class="col-md-3 col-lg-2 d-md-block bg-dark sidebar collapse" style="min-height: calc(100vh - 56px);">
            <div class="position-sticky pt-3">
                <h6 class="sidebar-heading d-flex justify-content-between align-items-center px-3 mt-4 mb-1 text-white">
                    <span>Admin Panel</span>
                </h6>
                <ul class="nav flex-column mb-2">
                    <li class="nav-item">
                        <a class="nav-link text-white" href="{{ url_for('admin.admin_dashboard') }}">
                            <i class="bi bi-speedometer2 me-2"></i> Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link text-white" href="{{ url_for('admin.admin_games') }}">
                            <i class="bi bi-controller me-2"></i> Games
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link text-white" href="{{ url_for('admin.admin_orders') }}">
                            <i class="bi bi-cart me-2"></i> Orders
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link text-white" href="{{ url_for('admin.admin_payment_methods') }}">
                            <i class="bi bi-credit-card me-2"></i> Payment Methods
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link text-white" href="{{ url_for('admin.admin_users') }}">
                            <i class="bi bi-people me-2"></i> Users
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link text-white" href="{{ url_for('admin.admin_sales_report') }}">
                            <i class="bi bi-graph-up me-2"></i> Sales Report
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active bg-primary text-white" href="{{ url_for('admin.admin_settings') }}">
                            <i class="bi bi-gear me-2"></i> Settings
                        </a>
                    </li>
                </ul>
                
                <hr class="text-white">
                
                <ul class="nav flex-column">
                    <li class="nav-item">
                        <a class="nav-link text-white" href="{{ url_for('main.index') }}">
                            <i class="bi bi-house me-2"></i> Back to Store
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link text-white" href="{{ url_for('auth.logout') }}">
                            <i class="bi bi-box-arrow-right me-2"></i> Logout
                        </a>
                    </li>
                </ul>
            </div>
        </div>

        <!-- Main Content -->
        <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
            <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                <h1 class="h2">
                    <i class="bi bi-gear me-2"></i>Admin Settings
                </h1>
                <div class="btn-toolbar mb-2 mb-md-0">
                    <div class="btn-group me-2">
                        <a href="{{ url_for('admin.admin_dashboard') }}" class="btn btn-sm btn-outline-secondary">
                            <i class="bi bi-arrow-left me-1"></i> Back to Dashboard
                        </a>
                    </div>
                </div>
            </div>

            <!-- Flash Messages -->
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                        <div class="alert alert-{{ 'danger' if category == 'error' else 'success' }} alert-dismissible fade show mb-4">
                            {{ message }}
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>
                    {% endfor %}
                {% endif %}
            {% endwith %}

            <div class="row">
                <div class="col-lg-8">
                    <div class="card shadow-sm mb-4">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0">
                                <i class="bi bi-person-badge me-2"></i>Account Settings
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="alert alert-info mb-4">
                                <i class="bi bi-info-circle me-2"></i>
                                Update your admin account details. All changes require current password verification for security.
                            </div>

                            <form method="POST" action="{{ url_for('admin.admin_settings') }}" novalidate>
                                {{ form.hidden_tag() }}
                                
                                <!-- Profile Information -->
                                <div class="mb-4">
                                    <h6 class="border-bottom pb-2 mb-3">
                                        <i class="bi bi-person me-2"></i>Profile Information
                                    </h6>
                                    
                                    <div class="row mb-3">
                                        <div class="col-md-6">
                                            <label class="form-label">Username</label>
                                            {{ form.username(class="form-control" + (" is-invalid" if form.username.errors else ""), placeholder="Enter username") }}
                                            {% if form.username.errors %}
                                                <div class="invalid-feedback">
                                                    {% for error in form.username.errors %}
                                                        {{ error }}
                                                    {% endfor %}
                                                </div>
                                            {% endif %}
                                        </div>
                                        
                                        <div class="col-md-6">
                                            <label class="form-label">Email Address</label>
                                            {{ form.email(class="form-control" + (" is-invalid" if form.email.errors else ""), placeholder="Enter email") }}
                                            {% if form.email.errors %}
                                                <div class="invalid-feedback">
                                                    {% for error in form.email.errors %}
                                                        {{ error }}
                                                    {% endfor %}
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>

                                <!-- Current Password Verification -->
                                <div class="mb-4">
                                    <h6 class="border-bottom pb-2 mb-3">
                                        <i class="bi bi-shield-lock me-2"></i>Security Verification
                                    </h6>
                                    
                                    <div class="mb-3">
                                        <label class="form-label">Current Password <span class="text-danger">*</span></label>
                                        {{ form.current_password(class="form-control" + (" is-invalid" if form.current_password.errors else ""), placeholder="Enter your current password") }}
                                        {% if form.current_password.errors %}
                                            <div class="invalid-feedback">
                                                {% for error in form.current_password.errors %}
                                                    {{ error }}
                                                {% endfor %}
                                            </div>
                                        {% endif %}
                                        <small class="text-muted">Required to make any changes to your account</small>
                                    </div>
                                </div>

                                <!-- Password Change Section -->
                                <div class="mb-4">
                                    <h6 class="border-bottom pb-2 mb-3">
                                        <i class="bi bi-key me-2"></i>Change Password (Optional)
                                    </h6>
                                    
                                    <p class="text-muted mb-3">Leave blank if you don't want to change your password</p>
                                    
                                    <div class="row mb-3">
                                        <div class="col-md-6">
                                            <label class="form-label">New Password</label>
                                            {{ form.new_password(class="form-control" + (" is-invalid" if form.new_password.errors else ""), placeholder="Enter new password") }}
                                            {% if form.new_password.errors %}
                                                <div class="invalid-feedback">
                                                    {% for error in form.new_password.errors %}
                                                        {{ error }}
                                                    {% endfor %}
                                                </div>
                                            {% endif %}
                                        </div>
                                        
                                        <div class="col-md-6">
                                            <label class="form-label">Confirm New Password</label>
                                            {{ form.confirm_password(class="form-control" + (" is-invalid" if form.confirm_password.errors else ""), placeholder="Confirm new password") }}
                                            {% if form.confirm_password.errors %}
                                                <div class="invalid-feedback">
                                                    {% for error in form.confirm_password.errors %}
                                                        {{ error }}
                                                    {% endfor %}
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    
                                    <div class="alert alert-warning mb-0">
                                        <i class="bi bi-exclamation-triangle me-2"></i>
                                        Password must be at least 6 characters long
                                    </div>
                                </div>

                                <!-- Submit Button -->
                                <div class="d-flex justify-content-between align-items-center mt-4 pt-3 border-top">
                                    <div class="text-muted">
                                        <small>Account created: {{ current_user.created_at.strftime('%Y-%m-%d') }}</small>
                                    </div>
                                    <div>
                                        <a href="{{ url_for('admin.admin_dashboard') }}" class="btn btn-outline-secondary me-2">Cancel</a>
                                        {{ form.submit(class="btn btn-primary px-4") }}
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Right Sidebar - Security Tips -->
                <div class="col-lg-4">
                    <div class="card shadow-sm mb-4">
                        <div class="card-header bg-info text-white">
                            <h5 class="mb-0">
                                <i class="bi bi-shield-check me-2"></i>Security Tips
                            </h5>
                        </div>
                        <div class="card-body">
                            <ul class="list-group list-group-flush">
                                <li class="list-group-item d-flex">
                                    <i class="bi bi-check-circle-fill text-success me-2"></i>
                                    <span>Use a strong password with a mix of letters, numbers, and symbols</span>
                                </li>
                                <li class="list-group-item d-flex">
                                    <i class="bi bi-check-circle-fill text-success me-2"></i>
                                    <span>Never share your admin credentials with anyone</span>
                                </li>
                                <li class="list-group-item d-flex">
                                    <i class="bi bi-check-circle-fill text-success me-2"></i>
                                    <span>Always log out after using the admin panel on shared computers</span>
                                </li>
                                <li class="list-group-item d-flex">
                                    <i class="bi bi-check-circle-fill text-success me-2"></i>
                                    <span>Consider changing your password regularly for enhanced security</span>
                                </li>
                                <li class="list-group-item d-flex">
                                    <i class="bi bi-check-circle-fill text-success me-2"></i>
                                    <span>Enable two-factor authentication if available</span>
                                </li>
                            </ul>
                        </div>
                    </div>

                    <div class="card shadow-sm">
                        <div class="card-header bg-warning">
                            <h5 class="mb-0">
                                <i class="bi bi-exclamation-triangle me-2"></i>Important Notes
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="alert alert-warning mb-3">
                                <strong><i class="bi bi-key me-1"></i>Password Change</strong>
                                <p class="mb-0">If you change your password, you will need to log in again with the new password.</p>
                            </div>
                            <div class="alert alert-danger mb-0">
                                <strong><i class="bi bi-x-circle me-1"></i>Email Change</strong>
                                <p class="mb-0">Changing your email will affect password recovery and notifications.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const form = document.querySelector('form');
        const newPassword = document.getElementById('{{ form.new_password.id }}');
        const confirmPassword = document.getElementById('{{ form.confirm_password.id }}');
        
        form.addEventListener('submit', function(e) {
            // Check if new password is filled but confirm password is empty
            if (newPassword.value && !confirmPassword.value) {
                e.preventDefault();
                alert('Please confirm your new password');
                confirmPassword.focus();
                return false;
            }
            
            // Check if passwords match
            if (newPassword.value && newPassword.value !== confirmPassword.value) {
                e.preventDefault();
                alert('New passwords do not match');
                newPassword.focus();
                return false;
            }
            
            // Check password length
            if (newPassword.value && newPassword.value.length < 6) {
                e.preventDefault();
                alert('Password must be at least 6 characters long');
                newPassword.focus();
                return false;
            }
            
            return true;
        });
    });
</script>
{% endblock %}